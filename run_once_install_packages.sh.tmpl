#!/bin/bash

# {{ if eq .chezmoi.os "darwin" }}
echo "Installing essential packages on macOS..."

# ðŸ  **1ï¸âƒ£ Install Homebrew (if not installed)**
if ! command -v brew &>/dev/null; then
    echo "Homebrew not found. Installing..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi
brew update

# ðŸ”  **2ï¸âƒ£ Install Fonts**
brew install --cask font-noto-nerd-font
fc-cache -fv
echo "âœ… Installed Noto Sans Nerd Font"

# ðŸ›  **3ï¸âƒ£ Install Core CLI Utilities**
brew install fish tmux neovim zoxide eza git gitui ripgrep fzf bat jq fd bottom starship tree tree-sitter

# ðŸ–¥ **4ï¸âƒ£ Install Programming Languages & Tools**
brew install node lua zig rustup postgresql

# Install Elixir via `asdf`
if ! command -v asdf &>/dev/null; then
    echo "Installing asdf for version management..."
    brew install asdf
fi

echo "Installing Elixir via asdf..."
asdf plugin-add elixir || true
asdf install elixir latest
asdf global elixir latest

# ðŸš€ **5ï¸âƒ£ Install Language Servers (LSPs)**
brew install \
    typescript-language-server \
    yaml-language-server \
    lua-language-server \
    elixir-ls \
    rust-analyzer

# ðŸ”§ **6ï¸âƒ£ Install Formatters**
brew install \
    prettier \
    shfmt \
    sqlfluff \
    taplo \
    nixfmt \
    zigfmt \
    yamlfmt \
    pgformatter \
    stylua

# ðŸ” **7ï¸âƒ£ Install Linters**
brew install \
    luacheck \
    eslint_d \
    yamllint \
    sqlfluff \
    statix

# ðŸ“¦ **8ï¸âƒ£ Install GUI Apps**
brew install --cask alacritty raycast nikitabobko/tap/aerospace

# ðŸ“ Sketchybar installation
brew tap FelixKratz/formulae
brew install sketchybar

# ðŸ”Œ **9ï¸âƒ£ Set up Tmux Plugin Manager (TPM)**
if [ ! -d "$HOME/.tmux/plugins/tpm" ]; then
    git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm
else
    cd ~/.tmux/plugins/tpm && git pull
fi
echo "Installing tmux plugins..."
$HOME/.tmux/plugins/tpm/bin/install_plugins

# ðŸ”‘ **ðŸ”Ÿ Set up GPG Pinentry for macOS**
brew install pinentry-mac
mkdir -p ~/.gnupg
chmod 700 ~/.gnupg

BREW_PREFIX=$(brew --prefix)
echo "pinentry-program $BREW_PREFIX/bin/pinentry-mac" > ~/.gnupg/gpg-agent.conf
chmod 600 ~/.gnupg/gpg-agent.conf

# Restart GPG agent
gpgconf --kill gpg-agent
gpgconf --launch gpg-agent

echo "âœ… Installation complete!"
# {{ end }}

